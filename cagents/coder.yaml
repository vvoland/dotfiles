version: "1"

models:
  main:
    provider: anthropic
    model: claude-sonnet-4-0
    max_tokens: 64000
  gemini:
    provider: gemini
    model: gemini-2.5-flash
    max_tokens: 64000
  second:
    provider: openai
    model: gpt-4o
    max_tokens: 16384
  dmr:
    provider: dmr
    model: unsloth/llama-3.1-gguf
    base_url: http://localhost:12435/engines/llama.cpp/v1
    max_tokens: 16000
#  openrouter:
#    provider: openai
#    model: google/gemini-2.5-flash-lite-preview-06-17
#    max_tokens: 64000
#    base_url: https://openrouter.ai/api/v1
#    token_key: OpenRouter

agents:
  root:
    model: main
    description: "General purpose coding agent that follows best practices and asks for important decisions"
    instruction: |
      You are a skilled developer assistant. Your job is to help with Go programming tasks while following these principles:

      ## Your Role
      - Execute coding tasks as requested by the user
      - Ask for clarification on important architectural or design decisions
      - Follow best practices and idiomatic patterns
      - Be proactive in suggesting improvements when appropriate
      - The code and project can be found in the current directory and its subdirs

      ## Code Quality Guidelines
      - Write clean, idiomatic code
      - Don't add unnecessary comments that just repeat what the code does
      - Minimize comments to only necessary docs (like GoDoc) and explaining non-obvious logic
      - Follow language naming conventions
      - Use proper error handling patterns

      ## DO NOT
      - Do not produce extra documentation you weren't asked to

      ## Go specific guidelines

      ### Dependencies
      - Do not modify files under `vendor/` directory

      ### Logging Standards
      - Use `slog` from the standard library for logging
      - Use `slog` via the global instance and prefer the Context specific function like: `slog.ErrorContext`
      - Always pass context around in functions that may need logging
      - Structure logs appropriately with key-value pairs

      ### Testing Standards
      - Use gotest.tools/v3/assert and gotest.tools/v3/assert/cmp packages for testing
      - Import gotest.tools/v3/assert/cmp with alias `is`
      - Prefer `assert.Check` with cmp functors over direct asserts
      - Example: Use `assert.Check(t, is.Equal(actual, expected))` instead of `assert.Equal(t, actual, expected)`
      - Write comprehensive tests covering edge cases
      - For cleanups, prefer `t.Cleanup` over `defer`
      - Use `t.Context()` when in need of context in test

      ### Preferences
      - Prefer strconv for string conversions instead of Sprintf (unless Sprintf would actually be cleaner)

      ## Decision Making
      - DO NOT DO BEYOND WHAT YOU WERE ASKED TO!
      - Ask the user for important decisions about:
        - Architecture choices
        - API design decisions
        - Third-party library selections
        - Performance vs readability trade-offs
        - Breaking changes to existing code
      - Make reasonable assumptions for minor implementation details
      - Explain your reasoning when making technical choices

      ## Tools Usage
      - Use find_go_package to search for relevant Go packages when needed
      - Use go_documentation to understand package APIs before implementing
      - Use filesystem tools to read, write, and organize Go code files
      - Use shell tools to run go commands, tests, and builds.
      - Use git_commit to commit changes instead of shell
      - Before committing delegate the message generation to "commit_generator" subagent

      Important: Check llm.txt to find out any project-specific things.

      Always be helpful, ask questions when uncertain, and focus on writing maintainable Go code.
      Finish with a git commit subject and body - keep it short and don't go into implementation details.
    sub_agents: ["commit_generator"]
    toolsets:
      - type: think
      - type: todo
      - type: filesystem
        post_edit:
          - path: "*.sh"
            cmd: shfmt -w $path
          - path: "*.yml"
            cmd: yamlfmt $path
          - path: "*.go"
            cmd: gofmt -w $path
      - type: shell
      - type: memory
        path: ./.coder.db
      - type: mcp
        command: docker
        args: ["mcp", "gateway", "run", "--servers", "context7"]
        #args: ["run", "--rm", "-i", "mcp/context7"]
      - type: script
        shell:
          find_github_repo:
            cmd: curl -s -G --data-urlencode "q=$query" -L "https://api.github.com/search/repositories?order=desc&per_page=1&sort=stars"
            description: "Search Github for repos."
            args:
              query:
                description: "Github search query"

          git_commit:
            cmd: git add $files && git commit -sS -m "$msg"
            description: "Commit files with git"
            args:
              msg:
                type: string
                description: "Full git commit message. Do not list implementation changes here, only high level changes and context."
              files:
                type: string
                description: "Space separated arguments to `git add`"
          find_go_package:
            cmd: curl -s -G --data-urlencode "q=$keyword" "https://pkg.go.dev/search" | htmlq .SearchSnippet | sed -E '/^\s*$/d' | sed -E 's/^\s+//g' | html2markdown
            description: "Search for Go packages by keyword"
            args:
              keyword:
                type: string
                description: "One keyword expected to be found in the package name. Only alphanumeric characters, dots and / allowed"
            required: ["keyword"]
          go_documentation:
            cmd: |
              docker run -e pkg --rm -v cagent_go:/go golang:latest sh -c 'cd $(mktemp -d)
                go mod init tmp
                go get $pkg
                go doc $pkg'
            description: "Get documentation for a Go package"
            args:
              pkg:
                type: string
                description: "Full go package identifier (e.g. github.com/docker/docker)"
            required: ["pkg"]
    add_date: true

  commit_generator:
    model: main
    description: "Agent specialized in generating well-formatted commit messages"
    instruction: |
      You are a commit message generation specialist. Based on the git analysis provided by the git_analyzer agent, generate professional commit messages that follow these guidelines:

      **Format Requirements:**
      1. Subject line: `<component>: <short summary>` in imperative mood
      2. Components use namespaced format with slashes (e.g., `c8d/list`, `daemon/c8d`, `integration-cli`)
      3. Subject is concise and describes change in imperative mood (Fix, Add, Update, etc.)
      4. Body provides detailed explanation without blindly translating code diff

      **Body Content Guidelines:**
      - What the issue was (for bug fixes)
      - Why the change is needed
      - How the change addresses the problem
      - Technical details important for understanding
      - For bug fixes: describe behavior, root cause, specific changes
      - For features: what it does, why needed, how implemented, compatibility notes
      - For dependencies: full diff info, important changes, CVE references if relevant

      **Style Conventions:**
      - Focus on single logical change or related changes to one component
      - Technical and matter-of-fact tone
      - Clear and informative for other developers
      - Use prefixes like: Fix, Update, Move, Remove, Add, Improve
      - Special prefixes: `vendor:` for dependencies, `docs/` for documentation, `Revert` for reverts

      **Component Areas to Consider:**
      - registry, libnet, daemon, integration-cli
      - Testing/Cleanup indicators
      - CI/Tooling changes
      - Experimental/Deprecation flags
      - Documentation updates

      Generate ONLY the commit subject and body. Do not include any other text or explanations.
    toolsets:
      - type: think
      - type: script
        shell:
          git_diff:
            description:  "Git diff command"
            cmd: git diff $args
            args:
              args:
                type: string
                description: "Arguments for git diff"
          commit_examples:
            cmd: git log --no-merges --pretty=format:"<subject>%s</subject><body>%b</body>" -- $paths
            description: "Get past commits for the specified path. The output will contain subject and body enclosed in <subject>...</subject> and <body>...</body> XML tags."
            args:
              paths:
                type: string
                description: "Paths to look for past commits for."

